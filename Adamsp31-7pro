#!/bin/bash

# Script: adamsp31-7pro
# Descripción: Elimina programas listados en programas.txt
# Autor: Adam
# Fecha: $(date 12-11-2025)

# Configuración
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROGRAMS_FILE="$SCRIPT_DIR/programas.txt"
LOG_FILE="$SCRIPT_DIR/desinstalacion_$(date +%Y%m%d_%H%M%S).log"

# Colores para la salida
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # Sin color

# Función para mostrar mensajes
log_message() {
    local message="$1"
    echo -e "$message"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" | sed 's/\x1b\[[0-9;]*m//g' >> "$LOG_FILE"
}

# Verificar si se ejecuta como root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Este script debe ejecutarse con privilegios de superusuario${NC}"
    echo -e "${YELLOW}Usa: sudo $0${NC}"
    exit 1
fi

# Verificar si existe el archivo programas.txt
if [ ! -f "$PROGRAMS_FILE" ]; then
    echo -e "${RED}Error: No se encuentra el archivo 'programas.txt'${NC}"
    echo -e "${YELLOW}Debe estar en el mismo directorio que el script: $SCRIPT_DIR${NC}"
    exit 1
fi

# Verificar si el archivo está vacío
if [ ! -s "$PROGRAMS_FILE" ]; then
    echo -e "${RED}Error: El archivo 'programas.txt' está vacío${NC}"
    exit 1
fi

# Mostrar encabezado
clear
echo -e "${BLUE}==============================================${NC}"
echo -e "${BLUE}  DESINSTALADOR AUTOMÁTICO DE PROGRAMAS${NC}"
echo -e "${BLUE}==============================================${NC}"
echo ""
log_message "Iniciando proceso de desinstalación"
log_message "Archivo de programas: $PROGRAMS_FILE"
echo ""

# Leer programas del archivo
echo -e "${YELLOW}Programas a desinstalar:${NC}"
cat "$PROGRAMS_FILE"
echo ""

# Pedir confirmación
read -p "¿Deseas continuar con la desinstalación? (s/n): " confirm
if [[ ! "$confirm" =~ ^[sS]$ ]]; then
    echo -e "${YELLOW}Operación cancelada por el usuario${NC}"
    log_message "Operación cancelada por el usuario"
    exit 0
fi

echo ""
echo -e "${BLUE}Iniciando desinstalación...${NC}"
echo ""

# Contadores
total=0
success=0
failed=0
not_found=0

# Procesar cada programa
while IFS= read -r program; do
    # Eliminar espacios en blanco y líneas vacías
    program=$(echo "$program" | xargs)
    
    if [ -z "$program" ]; then
        continue
    fi
    
    total=$((total + 1))
    echo -e "${BLUE}[$total] Procesando: ${NC}$program"
    
    # Verificar si el paquete está instalado
    if dpkg -l | grep -qw "^ii.*$program"; then
        log_message "Desinstalando: $program"
        
        # Intentar desinstalar con apt
        if apt-get remove --purge -y "$program" >> "$LOG_FILE" 2>&1; then
            echo -e "${GREEN}      ✓ Desinstalado exitosamente${NC}"
            log_message "✓ $program desinstalado exitosamente"
            success=$((success + 1))
        else
            echo -e "${RED}      ✗ Error al desinstalar${NC}"
            log_message "✗ Error al desinstalar $program"
            failed=$((failed + 1))
        fi
    else
        echo -e "${YELLOW}      △ No está instalado o no se encuentra${NC}"
        log_message "△ $program no está instalado"
        not_found=$((not_found + 1))
    fi
    
    echo ""
done < "$PROGRAMS_FILE"

# Limpiar paquetes huérfanos
echo -e "${BLUE}Limpiando paquetes no utilizados...${NC}"
apt-get autoremove -y >> "$LOG_FILE" 2>&1
apt-get autoclean >> "$LOG_FILE" 2>&1
echo -e "${GREEN}✓ Limpieza completada${NC}"
echo ""

# Mostrar resumen
echo -e "${BLUE}==============================================${NC}"
echo -e "${BLUE}          RESUMEN DE OPERACIONES${NC}"
echo -e "${BLUE}==============================================${NC}"
echo -e "Total de programas procesados: ${BLUE}$total${NC}"
echo -e "Desinstalados exitosamente:    ${GREEN}$success${NC}"
echo -e "No encontrados/instalados:     ${YELLOW}$not_found${NC}"
echo -e "Errores:                       ${RED}$failed${NC}"
echo -e "${BLUE}==============================================${NC}"
echo -e "Log detallado guardado en:"
echo -e "${YELLOW}$LOG_FILE${NC}"
echo -e "${BLUE}==============================================${NC}"

log_message "Proceso finalizado - Éxitos: $success, No encontrados: $not_found, Errores: $failed"

exit 0
